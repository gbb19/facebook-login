@startuml
actor Admin
participant Frontend
participant Backend
participant Facebook

Admin ->> Frontend: Log in with app auth
Frontend ->> Backend: GET /shop/{shopId}/facebook/page/subscribe

note right of Backend
  Create random state + nonce
  Encode & sign to create secure_state
end note

Backend -->> Frontend: Return Facebook login URL + secure_state

Admin ->> Frontend: Click Facebook login
Frontend ->> Facebook: Open Facebook login popup (URL + secure_state)
Facebook -->> Admin: User logs in and selects a page
Facebook ->> Frontend: Redirect back (code + secure_state)

Frontend ->> Backend: POST /shop/{shopId}/facebook/page/subscribe\nwith code + secure_state + auth token

Backend ->> Backend: Verify secure_state (signature + expiration)

alt secure_state is valid
    Backend ->> Facebook: Exchange code for user access token
    Facebook -->> Backend: Return user access token

    Backend ->> Facebook: Get page access token (selected page)
    Facebook -->> Backend: Return page access token

    Backend ->> Backend: Save page_id + page_access_token (in internal DB)

    Backend ->> Facebook: Subscribe to webhook (for each page)
    Facebook -->> Backend: OK

    Backend -->> Frontend: Login success
else secure_state is invalid or expired
    Backend -->> Frontend: Return error
end
@enduml